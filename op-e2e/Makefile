test: test-legacy test-espresso

test-legacy: pre-test
	go test -v ./...

test-espresso: pre-test
	# Not all the existing tests work in Espresso mode. We have selectively enabled some here. To
	# enable more once they start working, simply add to this command (and change the corresponding
	# command in .circleci/config.yml).
	go test -v \
		-l1-allocs ../.devnet-espresso/allocs-l1.json \
		-l1-deployments ../.devnet-espresso/addresses.json \
		-deploy-config ../packages/contracts-bedrock/deploy-config/devnetL1-espresso.json \
		-parallel 1 \
		-run "TestMissingGasLimit|TestGethOnlyPendingBlockIsLatest|TestInvalidDepositInFCU|TestRegolith|TestPreregolith|TestSystemE2E|TestConfirmationDepth|TestMintOnRevertedDeposit|TestSystemP2PAltSync|TestSystemRPCAltSync|TestWithdrawals|TestERC20BridgeDeposits" \
		./...

cannon-prestate:
	make -C .. cannon-prestate

# We depend on the absolute pre-state generated by cannon to deploy the dispute game contracts.
devnet-allocs: pre-test-cannon
	make -C .. devnet-allocs
devnet-allocs-espresso: pre-test-cannon
	make -C .. devnet-allocs-espresso

pre-test: pre-test-cannon pre-test-allocs


pre-test-cannon:
	@if [ ! -e ../op-program/bin ]; then \
		make cannon-prestate; \
	fi

pre-test-allocs: 
	@if [ ! -e ../.devnet ]; then \
		make devnet-allocs; \
	fi
	@if [ ! -e ../.devnet-espresso ]; then \
		make devnet-allocs-espresso; \
	fi

clean:
	rm -r ../.devnet
	rm -r ../.devnet-espresso
	rm -r ../op-program/bin

lint:
	golangci-lint run -E goimports,sqlclosecheck,bodyclose,asciicheck,misspell,errorlint --timeout 5m -e "errors.As" -e "errors.Is" ./...

.PHONY: \
	test \
	lint
